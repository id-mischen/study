<?phpnamespace app\index\controller;use think\Controller;use think\Validate;use app\index\model\Infor as InforModel;use app\index\model\User;use app\index\model\Upload;class Infor extends Controller{    public function InsertData(){        if(request()->isPost()){            $postdata = input('post.');            $validate = new Validate([                ["nickname","require|length:3,10","用户名不为空|用户名长度在3-10之间"],                ["city","require|length:2,5","城市不为空|城市长度在2-5之间"],                ["company","require|length:3,10","公司不为空|公司长度在3-10之间"],                ["address","require|length:3,10","地址不为空|地址长度在3-10之间"],                ["signature","require","签名不为空"],                ["myself","require","自我介绍不为空"],            ]);            if(!$validate->check($postdata)){                echo $validate->getError();                $this->error('');            }            $user_id = session('user.id');            $user = InforModel::create([                'name'=>input('post.nickname'),                'city'=>input('post.city'),                'company'=>input('post.company'),                'address'=>input('post.address'),                'person'=>input('post.signature'),                'myself'=>input('post.myself'),                'user_id'=>$user_id,            ]);            if($user){                echo "插入成功";            }else{                echo "插入失败";            }        }        //插入成功，换session。        session('information',null);        $information = InforModel::getByUserId(session('user.id'));        session('information',$information);        $this->assign([            'user'=>session('user'),            'show_img'=>session('show_img'),        ]);        return $this->fetch('Infor/my');    }    public function UpdateData(){        if(request()->isPost()){            $postdata = input('post.');            $validate = new Validate([                ["nickname","require|length:3,10","用户名不为空|用户名长度在3-10之间"],                ["city","require|length:2,5","城市不为空|城市长度在2-5之间"],                ["company","require|length:3,10","公司不为空|公司长度在3-10之间"],                ["address","require|length:3,10","地址不为空|地址长度在3-10之间"],                ["signature","require","签名不为空"],                ["myself","require","自我介绍不为空"],            ]);            if(!$validate->check($postdata)){                echo $validate->getError();                $this->error('');            }            $user_id = session('user.id');            $user = new InforModel();            $user->where('user_id',$user_id)->update([                'name'=>input('post.nickname'),                'city'=>input('post.city'),                'company'=>input('post.company'),                'address'=>input('post.address'),                'person'=>input('post.signature'),                'myself'=>input('post.myself'),            ]);            if($user){                //更新成功，换session。                session('information',null);                $information = InforModel::getByUserId(session('user.id'));                session('information',$information);                echo "更新成功";            }else{                echo "更新失败";            }        }        $this->assign([            'user'=>session('user'),            'information'=>session('information'),            'show_img'=>session('show_img'),        ]);        return $this->fetch('infor/my');    }    public function avatar(){        if(request()->isPost()){            // 获取表单上传文件 例如上传了001.jpg            $file = request()->file('avatar');            // 移动到框架应用根目录/public/uploads/ 目录下            $info = $file->validate(['size'=>2000000,'ext'=>'jpg,png,gif'])->move(ROOT_PATH . 'public' . DS . 'uploads');            if($info){                // 成功上传后 获取上传信息,   插入数据库                // 输出 jpg   /*echo $info->getExtension()."<br>";                // 输出 20160820/name.jpg                echo $info->getSaveName()."<br>";                // 输出 name.jpg                echo $info->getFilename()."<br>";*/                $insert = new Upload();                $insert_img = $insert->where('user_id',session('user.id'))->update(['url'=>$info->getSaveName()]);                if($insert_img){                    //替换session                    $slt = Upload::getByUserId(session('user.id'));                    session('show_img',$slt);                    echo "上传成功";                }else{                    echo "上传失败";                }            }else{                // 上传失败获取错误信息                echo $file->getError();            }        }        $this->assign([            'user'=>session('user'),            'show_img'=>session('show_img'),        ]);        return $this->fetch();    }    public function password(){        if(request()->isPost()){            //判断原密码输入是否正确            //注意：从数据库中调取，不需要加MD5；            $old_password = session('user.password');            $input_password = md5(input('post.old_password'));            if($old_password == $input_password){                //判断新密码是否一致                $postdata = input('post.');                $validate = new Validate([                    ['new_password','require|length:6,10|confirm:password_confirmation','新密码不能为空|新密码长度在6-16之间|两次密码输入不一致']                ]);                if(!$validate->check($postdata)){                    echo $validate->getError();                    $this->error('');                }                //更新数据库,update:条件/更改的值,注意MD5                $update_password = User::update(['id'=>session('user.id'),'password'=>md5(input('post.new_password'))]);                if($update_password){                    //密码更改完成，销毁session,单个删除session(x,null) 批量删除session（null）;                    session(null);                    $this->success('密码修改成功','index/index/login');                }else{                    echo "密码修改失败";                }            }else{                echo "旧密码输入错误，请重新输入";            }        }        $this->assign([            'user'=>session('user'),            'show_img'=>session('show_img'),        ]);        return $this->fetch();    }    public function show(){        //判断是否存在信息            //为空时，则补全信息，进行插入            //非空时，则更新数据源        //session 从登录就开始传递了        $this->assign([            'user'=>session('user'),            'data'=>session('information'),            'show_img'=>session('show_img'),        ]);        return $this->fetch();    }}